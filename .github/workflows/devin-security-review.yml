name: Devin Security Review

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Necesario para obtener el commit anterior
    
    - name: Get commit information
      id: commit-info
      run: |
        COMMIT_SHA="${{ github.sha }}"
        COMMIT_URL="https://github.com/${{ github.repository }}/commit/${COMMIT_SHA}"
        echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
        echo "commit_url=${COMMIT_URL}" >> $GITHUB_OUTPUT
        echo "repository=${{ github.repository }}" >> $GITHUB_OUTPUT
    
    - name: Trigger Devin Security Review
      id: devin-review
      run: |
        # Construir el prompt para Devin
        PROMPT="Revisa este repositorio y verifica que el commit que se estÃ¡ haciendo (${COMMIT_URL}) no contenga ninguna vulnerabilidad de seguridad. 

        Repositorio: https://github.com/${{ github.repository }}
        Commit a revisar: ${COMMIT_URL}
        
        Por favor analiza:
        1. Vulnerabilidades de seguridad en el cÃ³digo
        2. ExposiciÃ³n de secretos o credenciales
        3. InyecciÃ³n de cÃ³digo malicioso
        4. Configuraciones inseguras
        5. Dependencias con vulnerabilidades conocidas
        
        Si encuentras algÃºn problema de seguridad, agrega un comentario detallado explicando:
        - QuÃ© vulnerabilidad encontraste
        - DÃ³nde se encuentra (archivo y lÃ­nea)
        - CÃ³mo solucionarla
        - Nivel de severidad (crÃ­tico, alto, medio, bajo)
        
        Si no encuentras problemas, confirma que el commit es seguro para ser integrado."

        # Llamar a la API de Devin
        RESPONSE=$(curl -s -X POST \
          -H "Authorization: Bearer ${{ secrets.DEVIN_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d "{
            \"prompt\": \"$PROMPT\",
            \"idempotent\": true,
            \"title\": \"Security Review - Commit ${{ steps.commit-info.outputs.commit_sha }}\"
          }" \
          https://api.devin.ai/v1/sessions)
        
        echo "Devin API Response: $RESPONSE"
        
        # Extraer session_id y url de la respuesta
        SESSION_ID=$(echo $RESPONSE | jq -r '.session_id // empty')
        SESSION_URL=$(echo $RESPONSE | jq -r '.url // empty')
        
        if [ -n "$SESSION_ID" ] && [ -n "$SESSION_URL" ]; then
          echo "session_id=${SESSION_ID}" >> $GITHUB_OUTPUT
          echo "session_url=${SESSION_URL}" >> $GITHUB_OUTPUT
          echo "âœ… Devin security review iniciada exitosamente"
          echo "ðŸ“‹ Session ID: ${SESSION_ID}"
          echo "ðŸ”— URL de la sesiÃ³n: ${SESSION_URL}"
        else
          echo "âŒ Error al crear la sesiÃ³n de Devin"
          echo "Response: $RESPONSE"
          exit 1
        fi
      env:
        COMMIT_URL: ${{ steps.commit-info.outputs.commit_url }}
    
    - name: Comment on PR with Devin session
      if: github.event_name == 'pull_request' && steps.devin-review.outputs.session_url
      uses: actions/github-script@v7
      with:
        script: |
          const sessionUrl = '${{ steps.devin-review.outputs.session_url }}';
          const sessionId = '${{ steps.devin-review.outputs.session_id }}';
          const commitUrl = '${{ steps.commit-info.outputs.commit_url }}';
          
          const comment = `## ðŸ”’ RevisiÃ³n de Seguridad con Devin
          
          Se ha iniciado una revisiÃ³n automÃ¡tica de seguridad para este commit usando Devin AI.
          
          **Detalles:**
          - ðŸ“‹ Session ID: \`${sessionId}\`
          - ðŸ”— [Ver revisiÃ³n en Devin](${sessionUrl})
          - ðŸ“ Commit revisado: [${context.payload.pull_request.head.sha.substring(0, 7)}](${commitUrl})
          
          **Â¿QuÃ© se estÃ¡ revisando?**
          - Vulnerabilidades de seguridad en el cÃ³digo
          - ExposiciÃ³n de secretos o credenciales  
          - InyecciÃ³n de cÃ³digo malicioso
          - Configuraciones inseguras
          - Dependencias con vulnerabilidades conocidas
          
          Devin analizarÃ¡ el cÃ³digo y proporcionarÃ¡ un reporte detallado. Por favor revisa los resultados antes de hacer merge.
          
          ---
          *Esta revisiÃ³n fue generada automÃ¡ticamente por GitHub Actions*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: Add commit status
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const state = '${{ steps.devin-review.outcome }}' === 'success' ? 'success' : 'failure';
          const description = state === 'success' 
            ? 'Devin security review iniciada exitosamente' 
            : 'Error al iniciar la revisiÃ³n de seguridad con Devin';
          
          github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: '${{ steps.commit-info.outputs.commit_sha }}',
            state: state,
            target_url: '${{ steps.devin-review.outputs.session_url }}',
            description: description,
            context: 'devin/security-review'
          });
    
    - name: Summary
      if: always()
      run: |
        echo "## ðŸ”’ Resumen de RevisiÃ³n de Seguridad" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit revisado:** ${{ steps.commit-info.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Repositorio:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.devin-review.outcome }}" = "success" ]; then
          echo "**Estado:** âœ… RevisiÃ³n iniciada exitosamente" >> $GITHUB_STEP_SUMMARY
          echo "**Session ID:** ${{ steps.devin-review.outputs.session_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL de Devin:** ${{ steps.devin-review.outputs.session_url }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Estado:** âŒ Error al iniciar la revisiÃ³n" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ConfiguraciÃ³n requerida:" >> $GITHUB_STEP_SUMMARY
        echo "- AsegÃºrate de tener configurado el secret \`DEVIN_API_KEY\` en tu repositorio" >> $GITHUB_STEP_SUMMARY
        echo "- El secret debe contener tu token de API de Devin" >> $GITHUB_STEP_SUMMARY
